<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="lhdt.persistence.GeometryMapper">
    <!-- 운영 정책 정보 -->
    <select id="getIntersectionDesignLayerLands" parameterType="spatialOperationInfo" resultType="designLayerLand">
        /* getIntersectionDesignLayerLands */
        SELECT * FROM design_layer_land
        WHERE enable_yn='Y'
        <choose>
            <when test="buffer !=null and buffer > 0" >
                AND st_intersects(st_buffer(ST_GeomFromText(#{wkt},4326),#{buffer}), the_geom) = true
            </when>
            <otherwise>
                AND st_intersects(ST_GeomFromText(#{wkt},4326), the_geom) = true
            </otherwise>
        </choose>
        <if test="maxFeatures !=null and maxFeatures > 0">
            limit #{maxFeatures}
        </if>
    </select>

    <select id="getIntersectionDesignLayerBuildings" parameterType="spatialOperationInfo" resultType="designLayerBuilding">
        /* getIntersectionDesignLayerBuildings */
        SELECT * FROM design_layer_building
        WHERE enable_yn='Y'
        <choose>
            <when test="buffer !=null and buffer > 0" >
                AND st_intersects(st_buffer(ST_GeomFromText(#{wkt},4326),#{buffer}), the_geom) = true
            </when>
            <otherwise>
                AND st_intersects(ST_GeomFromText(#{wkt},4326), the_geom) = true
            </otherwise>
        </choose>
        <if test="maxFeatures !=null and maxFeatures > 0">
            limit #{maxFeatures}
        </if>
    </select>

    <select id="getIntersectionDatas" parameterType="spatialOperationInfo" resultType="dataInfo">
        /* getIntersectionDatas */
        SELECT * FROM data_info
        <choose>
            <when test="buffer !=null and buffer > 0" >
                WHERE st_intersects(st_buffer(ST_GeomFromText(#{wkt},4326),#{buffer}), location) = true
            </when>
            <otherwise>
                WHERE st_intersects(ST_GeomFromText(#{wkt},4326), location) = true
            </otherwise>
        </choose>
        <if test="maxFeatures !=null and maxFeatures > 0">
            limit #{maxFeatures}
        </if>
    </select>
</mapper>