<html xmlns:th="http://www.thymeleaf.org" th:lang="${accessibility}">
<body>
    <header id="headerWrap">
        <div class="HamMenu on"><a href="#">메뉴</a></div>
        <h1>
        	LHDT Digital Twin Platform        	
        </h1>
        <span class="select-urban-group-container"></span>
        <div class="gnb">
            <th:block th:if="${session.USER_SESSION}">
                <ul>
                    <li class="user">
                        <span th:text="${session.USER_SESSION.userName}"><th:block th:text="#{common.sir}"></th:block></span>
                        <a href="/guide/help" class="api" th:title="#{common.api.document}" onclick="goMagoAPIGuide(this.href);return false;">
                            <th:block th:text="#{common.api.document}"></th:block></a>
                        <a href="/sign/signout" class="sign" title="Sign out">Sign out</a>
                    </li>
                </ul>
            </th:block>
            <th:block th:unless="${session.USER_SESSION}">
                <ul>
                    <li>
                        <a href="/guide/help" class="api" th:title="#{common.api.document}" onclick="goMagoAPIGuide(this.href);return false;">
                            <th:block th:text="#{common.api.document}"></th:block></a>
                    </li>
                    <li class="user">
                        <a href="/sign/signin" class="sign">Sign in</a>
                    </li>
                </ul>
            </th:block>
        </div>

		<script>
        window.addEventListener('load', function() {
		    let _hamMenuClick = function(){
                Ppui.click('.HamMenu', function(){
                    if(Ppui.hasClass(this, 'on')){
                        Ppui.hide(['.navWrap', '#gnbWrap']);		
                        document.querySelector('#magoContainer').style.width = '100%';
                    }else{
                        Ppui.show(['.navWrap', '#gnbWrap']);					
                        document.querySelector('#magoContainer').style.width = 'calc(100% - 430px)';
                    }
                    
                    //
                    Ppui.toggleClass(this, 'on');
                });
            };

            //
            let interval = setInterval(function(){
                if(typeof MAGO3D_INSTANCE !== "undefined" && MAGO3D_INSTANCE) {
                    clearInterval(interval);
                    //
                    _hamMenuClick();
                }
            }, 500);

		});
		</script>
		
		
		<!-- 
		도시 그룹 
		1021
		 -->
		<script>		
		window.addEventListener('load', function(){
			//도시 그룹 목록 조회
			let _getUrbanGroupsAsync = function(){
				$.get('../api/urban-groups', function(res){
					
					if(Pp.isEmpty(res) || Pp.isEmpty(res._embedded) || Pp.isEmpty(res._embedded.urbanGroups)){
						return;
					}
					
					
					let urbanGroups = res._embedded.urbanGroups;
					
					
					//parent0 목록만 추출
					let parent0UrbanGroups = _getUrbanGroupsByParent(urbanGroups, 0);
					
					
					//children 목록 추출 by parent0
					for(let i=0; i<parent0UrbanGroups.length; i++){
						let d = parent0UrbanGroups[i];
						
						d.children = _getUrbanGroupsByParent(urbanGroups, d.urbanGroupId);
					}
					
					
					//select생성
					let htmlString = _createSelectHtml(parent0UrbanGroups);
					
					
					//화면에 표시
					$('span.select-urban-group-container').append(htmlString);
					

					//change 이벤트 등록
					$('select.urban-group').click(function(){
						let lon = $(this).find('option:selected').data('lon');
						let lat = $(this).find('option:selected').data('lat');
						
						if(Pp.isEmpty(lon) || Pp.isEmpty(lat)){
							return;
						}
						
						//해당 위치로 이동
						Ppmap.getManager().flyTo(lon, lat, 3000, 1);
						
						
						
						//TODO 데이터셋 선택
						
						
						
						
						setTimeout(function(){
							$('select.urban-group').val('');
							
						}, 1000);
					});
					
				});
			};
			
			
			
			//parent값으로 도시 그룹 목록 추출
			let _getUrbanGroupsByParent = function(urbanGroups, parent){
				let arr=[];
				
				for(let i=0; i<urbanGroups.length; i++){
					let d = urbanGroups[i];
					
					if(parent == d.parent){
						arr.push(d);
					}
				}
				
				return arr;
			};
			
			
			//도시 그룹 선택 html 문자열 생성
			let _createSelectHtml = function(parent0List){
				var source = $("#select-urban-group-template").html();
				var template = Handlebars.compile(source);
				return template({datas:parent0List});
				
			};
			
			
			
			//
			_getUrbanGroupsAsync();
		});
		</script>
		
		<!-- 도시 그룹 select handlebar template -->
		<script id="select-urban-group-template" type="text/x-handlebars-template">
			<select class="urban-group" style="padding:5px; margin-left:-326px; margin-top:10px; ">
				<option value="">선택하세요</option>
				{{#each datas}}
				<optgroup label="{{urbanGroupName}}">
					{{#each children}}
						<option value="{{urbanGroupId}}" data-lon="{{longitude}}" data-lat="{{latitude}}">{{urbanGroupName}}</option>
					{{/each}}
				</optgroup>
				{{/each}}
			</select>  
		</script>
    </header>
</body>
</html>